server {
    listen    80;
    server_name  [DOMAIN];

    return 301 https://[DOMAIN]$request_uri;

    access_log  logs/[DOMAIN].access.log  main;
}

# HTTPS server
server {
    listen   443 ssl http2;
    server_name  [DOMAIN];

    access_log  logs/[DOMAIN].access.log  main;

    # 屏蔽特定 UA
    include /usr/local/nginx/deny/deny_angnt.conf;

    ssl_certificate      [DOMAIN_CER];
    ssl_certificate_key  [DOMAIN_KEY];

    ssl_dhparam [DHPARAM_PEM];

    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ciphers TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_session_cache    shared:SSL:3m;
    ssl_session_timeout  6m;

    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Xss-Protection "1; mode=block";
    add_header X-Content-Type-Options nosniff;
    add_header Strict-Transport-Security "max-age=15768000; includeSubdomains; preload";

    location = / {
        rewrite ^(.*)$ wiki/Wikipedia:首页 redirect;
    }

    location / {
          resolver 8.8.8.8;
          proxy_pass https://zh.m.wikipedia.org/;
          proxy_read_timeout 60;
          proxy_connect_timeout 60;
          proxy_redirect     off;
  
          sub_filter          zh.m.wikipedia.org  [DOMAIN];
          sub_filter          www.google.com      [DOMAIN_GOOGLE];
          sub_filter_once     off;
          proxy_set_header    Host              zh.m.wikipedia.org;
          proxy_set_header    Referer           https://zh.m.wikipedia.org;
          proxy_set_header    User-Agent        $http_user_agent;
          proxy_set_header    X-Real-IP         $remote_addr;
          proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
          proxy_set_header    Accept-Encoding   "";
          proxy_cookie_domain zh.m.wikipedia.org    [DOMAIN];
      }
      location ~ .*\.(php)$ {
          proxy_pass https://zh.m.wikipedia.org;

          proxy_set_header   Host              zh.m.wikipedia.org;
          proxy_set_header   Referer           https://zh.m.wikipedia.org;
          proxy_set_header   User-Agent        $http_user_agent;
          proxy_set_header   X-Real-IP         $remote_addr;
          proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      }
      location ~ .*\.(gif|jpg|jpeg|png|bmp|swfi|svg)$ {
          proxy_pass https://zh.m.wikipedia.org;

          proxy_set_header   Host              zh.m.wikipedia.org;
          proxy_set_header   Referer           https://zh.m.wikipedia.org;
          proxy_set_header   User-Agent        $http_user_agent;
          proxy_set_header   X-Real-IP         $remote_addr;
          proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
      }

    # 缓存
    location ~* ^.+\.(ico|gif|jpg|jpeg|png)$ { 
        access_log   off; 
        expires      1d;
    }   
    location ~* ^.+\.(css|js|txt|xml|swf|wav)$ {
        access_log   off;
        expires      24h;
    }
    location ~* ^.+\.(html|htm)$ {
        expires      1h;
    }    
    location ~* ^.+\.(eot|ttf|otf|woff|svg)$ {
        access_log   off;
        expires max;
    }
}

