server {
    listen    80 fastopen=50 reuseport;
    server_name  [DOMAIN];
    return 301 https://[DOMAIN]$request_uri;

    access_log  logs/[DOMAIN].access.log  main;
}

# HTTPS server
server {
    # TCP Fast Open 最大队列 50
    # reuseport：每个 Nginx Worker 都绑定同一个 TCP 端口 
    listen   443 ssl http2 fastopen=50 reuseport;
    server_name  [DOMAIN];

    access_log  logs/[DOMAIN].access.log  main;
    
    # 设置 www_authorize
    # IP 或者登录，任意一个条件符合，就可以访问
    satisfy any;
    allow 8.8.8.8;
    auth_basic "Login";
    # 配置用户名和密码
    # [在线 htpasswd 生成器](https://tool.oschina.net/htpasswd)
    auth_basic_user_file conf/htpasswd;


    # 屏蔽特定 UA
    include deny/deny_angnt.conf;

    ssl_certificate      [DOMAIN_CER];
    ssl_certificate_key  [DOMAIN_KEY];

    # DHE 密码器的 Diffie-Hellman 参数
    # 不是必须
    ssl_dhparam [DHPARAM_PEM];

    # 可以增加 TLSv1.1
    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ciphers TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_session_cache    shared:SSL:3m;
    ssl_session_timeout  6m;

    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Xss-Protection "1; mode=block";
    add_header X-Content-Type-Options nosniff;
    add_header Strict-Transport-Security "max-age=15768000; includeSubdomains; preload";

    location / {
          resolver 8.8.8.8;
          proxy_pass https://www.google.com.sg;
          proxy_read_timeout 60;
          proxy_connect_timeout 60;
          proxy_redirect     off;
  
          sub_filter          www.google.com.sg    [DOMAIN];
          sub_filter          zh.wikipedia.org     [DOMAIN_WIKI];
          sub_filter          zh.m.wikipedia.org   [DOMAIN_WIKI-M];
          sub_filter_once     off;
          proxy_set_header    Host              www.google.com.sg;
          proxy_set_header    Referer           https://www.google.com.sg;
          proxy_set_header    X-Real-IP         $remote_addr;
          proxy_set_header    User-Agent        $http_user_agent;
          proxy_cookie_domain www.google.com.sg [domain];
          proxy_set_header    Accept-Encoding   "";
          proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    }
    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$ {
        proxy_pass https://ssl.gstatic.com;

        proxy_set_header   Host              www.google.com.sg;
        proxy_set_header   Referer           https://www.google.com.sg;
        proxy_set_header   User-Agent        $http_user_agent;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    }
    location ~ .*\.(js|css)$ {
        proxy_pass https://apis.google.com;

        proxy_set_header   Host              www.google.com.sg;
        proxy_set_header   Referer           https://www.google.com.sg;
        proxy_set_header   User-Agent        $http_user_agent;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    }

    # 缓存
    location ~* ^.+\.(ico|gif|jpg|jpeg|png)$ { 
#        access_log   off; 
        expires      1d;
    }   
    location ~* ^.+\.(css|js|txt|xml|swf|wav)$ {
#        access_log   off;
        expires      24h;
    }
    location ~* ^.+\.(html|htm)$ {
#        access_log   off;
        expires      1h;
    }    
    location ~* ^.+\.(eot|ttf|otf|woff|svg)$ {
#        access_log   off;
        expires max;
    }
}

